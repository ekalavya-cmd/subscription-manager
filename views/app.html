<!DOCTYPE html>
<html lang="en" ng-app="subscriptionApp">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subscription Manager</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- AngularJS -->
    <script src="https://code.angularjs.org/1.8.2/angular.min.js"></script>

    <!-- Custom CSS -->
    <link href="/css/custom.css" rel="stylesheet" />
  </head>
  <body>
    <div ng-controller="SubscriptionController" class="container-fluid py-3">
      <!-- Header Navigation -->
      <nav class="navbar navbar-expand-lg navbar-custom mb-4">
        <div class="brand-container">
          <i class="bi bi-calendar-check brand-icon"></i>
          <span class="brand-text">Subscription Manager</span>
        </div>

        <div class="d-flex align-items-center ms-auto">
          <!-- Simplified Welcome Message -->
          <div class="welcome-container">
            <div class="welcome-text">
              <p class="welcome-greeting">Welcome back!</p>
              <p class="welcome-username">{{ getDisplayName() }}</p>
            </div>
          </div>

          <!-- Debug Button -->
          <button
            ng-if="showDebug"
            type="button"
            class="btn btn-sm btn-outline-secondary me-2"
            onclick="logger.showLogsModal()"
          >
            <i class="bi bi-bug"></i>
          </button>

          <!-- Logout Button -->
          <button ng-click="logout()" class="btn btn-gradient-danger">
            <i class="bi bi-box-arrow-right me-2"></i>
            Logout
          </button>
        </div>
      </nav>

      <!-- Dashboard Stats -->
      <div class="row mb-4">
        <div class="col-md-3 mb-3">
          <div class="card custom-card h-100">
            <div class="card-body text-center">
              <i
                class="bi bi-graph-up text-success"
                style="font-size: 2rem"
              ></i>
              <h5 class="card-title mt-2 mb-1">Total Active</h5>
              <h3 class="text-success mb-0">
                {{ getActiveSubscriptions().length }}
              </h3>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card custom-card h-100">
            <div class="card-body text-center">
              <i
                class="bi bi-currency-rupee text-primary"
                style="font-size: 2rem"
              ></i>
              <h5 class="card-title mt-2 mb-1">Active Expenses</h5>
              <h3 class="text-primary mb-0">
                ₹{{ getTotalMonthlyCost() | number:0 }}
              </h3>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card custom-card h-100">
            <div class="card-body text-center">
              <i class="bi bi-clock text-warning" style="font-size: 2rem"></i>
              <h5 class="card-title mt-2 mb-1">Upcoming</h5>
              <h3 class="text-warning mb-0">
                {{ getUpcomingSubscriptions().length }}
              </h3>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card custom-card h-100">
            <div class="card-body text-center">
              <i class="bi bi-x-circle text-danger" style="font-size: 2rem"></i>
              <h5 class="card-title mt-2 mb-1">Expired</h5>
              <h3 class="text-danger mb-0">
                {{ getExpiredSubscriptions().length }}
              </h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Subscription Form -->
      <div class="card custom-card mb-4">
        <div class="card-header bg-transparent">
          <h4 class="mb-0">
            <i class="bi bi-plus-circle me-2"></i>
            {{ newSubscription._id ? 'Edit Subscription' : 'Add New
            Subscription' }}
          </h4>
        </div>
        <div class="card-body">
          <form
            ng-submit="saveSubscription()"
            novalidate
            name="subscriptionForm"
          >
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="subName" class="form-label fw-semibold">
                  <i class="bi bi-tag me-1"></i>Service Name
                </label>
                <input
                  id="subName"
                  ng-model="newSubscription.name"
                  type="text"
                  class="form-control form-control-custom"
                  placeholder="e.g., Netflix, Spotify"
                  required
                  ng-keypress="moveToNextField($event, 0)"
                  name="name"
                />
              </div>

              <div class="col-md-6 mb-3">
                <label for="subCost" class="form-label fw-semibold">
                  <i class="bi bi-currency-rupee me-1"></i>Subscription Cost (₹)
                </label>
                <input
                  id="subCost"
                  ng-model="newSubscription.cost"
                  type="number"
                  class="form-control form-control-custom"
                  placeholder="199"
                  required
                  min="0"
                  step="0.01"
                  ng-keypress="moveToNextField($event, 1)"
                  name="cost"
                />
                <div class="form-text">
                  <i class="bi bi-info-circle me-1"></i>
                  Total cost for the subscription period
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="subStartDate" class="form-label fw-semibold">
                  <i class="bi bi-calendar-plus me-1"></i>Start Date
                </label>
                <input
                  id="subStartDate"
                  ng-model="newSubscription.startDate"
                  type="date"
                  class="form-control form-control-custom"
                  required
                  ng-keypress="moveToNextField($event, 2)"
                  name="startDate"
                  ng-change="validateDateRange(); updateStatusOptions(); handleExpiredStatus()"
                />
              </div>

              <div class="col-md-6 mb-3">
                <label for="subEndDate" class="form-label fw-semibold">
                  <i class="bi bi-calendar-x me-1"></i>End Date
                </label>
                <input
                  id="subEndDate"
                  ng-model="newSubscription.endDate"
                  type="date"
                  class="form-control form-control-custom"
                  required
                  ng-keypress="moveToNextField($event, 3)"
                  name="endDate"
                  ng-change="validateDateRange(); updateStatusOptions(); handleExpiredStatus()"
                />
                <div
                  ng-if="dateRangeError"
                  class="text-danger mt-1"
                  style="font-size: 0.8rem"
                >
                  {{ dateRangeError }}
                </div>
                <div class="form-text">
                  <i class="bi bi-info-circle me-1"></i>
                  This will be your renewal date
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="subProvider" class="form-label fw-semibold">
                  <i class="bi bi-building me-1"></i>Provider
                </label>
                <input
                  id="subProvider"
                  ng-model="newSubscription.provider"
                  type="text"
                  class="form-control form-control-custom"
                  placeholder="e.g., Netflix Inc."
                  required
                  ng-keypress="moveToNextField($event, 4)"
                  name="provider"
                />
              </div>

              <div class="col-md-6 mb-3">
                <label for="subStatus" class="form-label fw-semibold">
                  <i class="bi bi-info-circle me-1"></i>Status
                </label>
                <select
                  id="subStatus"
                  ng-model="newSubscription.status"
                  class="form-select form-control-custom"
                  required
                  ng-keypress="moveToNextField($event, 5)"
                  name="status"
                  ng-change="handleStatusChange()"
                >
                  <option value="">Select Status</option>
                  <option value="active" ng-if="isActiveStatusAvailable()">
                    Active
                  </option>
                  <option value="upcoming" ng-if="isUpcomingStatusAvailable()">
                    Upcoming
                  </option>
                  <option value="expired" ng-if="isExpiredStatusAvailable()">
                    Expired
                  </option>
                </select>
                <div class="form-text" ng-if="getStatusHelpText()">
                  <i class="bi bi-info-circle me-1"></i>
                  {{ getStatusHelpText() }}
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12 mb-3">
                <label for="subCancel" class="form-label fw-semibold">
                  <i class="bi bi-list me-1"></i>Cancellation Steps (Optional)
                </label>
                <textarea
                  id="subCancel"
                  ng-model="newSubscription.cancellationSteps"
                  class="form-control form-control-custom"
                  placeholder="How to cancel this subscription..."
                  rows="3"
                  ng-keypress="moveToNextField($event, 6)"
                  name="cancellationSteps"
                ></textarea>
              </div>
            </div>

            <!-- Subscription Duration Info -->
            <div
              ng-if="newSubscription.startDate && newSubscription.endDate && !dateRangeError"
              class="alert alert-info mb-3"
            >
              <i class="bi bi-info-circle me-2"></i>
              <strong>Duration:</strong> {{ getSubscriptionDuration() }} months
              <span class="ms-3">
                <strong>Monthly Cost:</strong> ₹{{ (newSubscription.cost /
                getSubscriptionDuration()) | number:2 }}
              </span>
            </div>

            <div class="row">
              <div class="col-md-6">
                <button
                  type="submit"
                  class="btn btn-gradient-primary btn-lg w-100 mb-2"
                  ng-disabled="subscriptionForm.$invalid || isSubmitting || dateRangeError"
                >
                  <span
                    ng-if="isSubmitting"
                    class="spinner-border spinner-border-sm me-2"
                  ></span>
                  <i class="bi bi-check-circle me-2" ng-if="!isSubmitting"></i>
                  {{ isSubmitting ? 'Saving...' : (newSubscription._id ? 'Update
                  Subscription' : 'Add Subscription') }}
                </button>
              </div>
              <div class="col-md-6">
                <button
                  type="button"
                  ng-click="clearOrCancel()"
                  class="btn btn-gradient-secondary btn-lg w-100 mb-2"
                >
                  <i class="bi bi-x-circle me-2"></i>
                  {{ newSubscription._id ? 'Cancel Edit' : 'Clear Form' }}
                </button>
              </div>
            </div>
          </form>

          <!-- Form Messages -->
          <div
            ng-if="subscriptionSuccess"
            class="alert alert-custom-success mt-3 fade-in"
          >
            <i class="bi bi-check-circle me-2"></i>{{ subscriptionSuccess }}
          </div>
          <div
            ng-if="subscriptionError"
            class="alert alert-custom-danger mt-3 fade-in"
          >
            <i class="bi bi-exclamation-triangle me-2"></i>{{ subscriptionError
            }}
          </div>
        </div>
      </div>

      <!-- SMS Reminder Section -->
      <div class="card custom-card mb-4">
        <div class="card-header bg-transparent">
          <h4 class="mb-0">
            <i class="bi bi-chat-dots me-2"></i>
            Send SMS Reminder
          </h4>
        </div>
        <div class="card-body">
          <form ng-submit="sendSMS()" novalidate name="smsForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="smsPhone" class="form-label fw-semibold">
                  <i class="bi bi-phone me-1"></i>Phone Number
                </label>
                <input
                  id="smsPhone"
                  ng-model="smsData.to"
                  type="tel"
                  class="form-control form-control-custom"
                  placeholder="+919876543210"
                  required
                  pattern="^\+[1-9]\d{9,14}$"
                  ng-keypress="moveToNextField($event, 0, 'sms')"
                  name="phone"
                />
                <div class="form-text">
                  <i class="bi bi-info-circle me-1"></i>
                  Use E.164 format (e.g., +919876543210)
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="smsMessage" class="form-label fw-semibold">
                  <i class="bi bi-chat-text me-1"></i>Message
                </label>
                <textarea
                  id="smsMessage"
                  ng-model="smsData.body"
                  class="form-control form-control-custom"
                  placeholder="Your subscription reminder message..."
                  required
                  rows="3"
                  ng-keypress="moveToNextField($event, 1, 'sms')"
                  name="message"
                ></textarea>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4">
                <button
                  type="submit"
                  class="btn btn-gradient-primary btn-lg w-100 mb-2"
                  ng-disabled="smsForm.$invalid || isSendingSMS"
                >
                  <span
                    ng-if="isSendingSMS"
                    class="spinner-border spinner-border-sm me-2"
                  ></span>
                  <i class="bi bi-send me-2" ng-if="!isSendingSMS"></i>
                  {{ isSendingSMS ? 'Sending...' : 'Send SMS' }}
                </button>
              </div>
              <div class="col-md-4">
                <button
                  type="button"
                  ng-click="clearSMS()"
                  class="btn btn-gradient-secondary btn-lg w-100 mb-2"
                >
                  <i class="bi bi-x-circle me-2"></i>
                  Clear SMS Form
                </button>
              </div>
              <div class="col-md-4">
                <button
                  type="button"
                  ng-click="testSMSReminders()"
                  class="btn btn-outline-info btn-lg w-100 mb-2"
                  ng-disabled="isTestingSMS"
                >
                  <span
                    ng-if="isTestingSMS"
                    class="spinner-border spinner-border-sm me-2"
                  ></span>
                  <i class="bi bi-bell me-2" ng-if="!isTestingSMS"></i>
                  {{ isTestingSMS ? 'Testing...' : 'Test Reminders' }}
                </button>
              </div>
            </div>
          </form>

          <!-- SMS Messages -->
          <div
            ng-if="smsMessage"
            class="alert alert-custom-success mt-3 fade-in"
          >
            <i class="bi bi-check-circle me-2"></i>{{ smsMessage }}
          </div>
          <div ng-if="smsError" class="alert alert-custom-danger mt-3 fade-in">
            <i class="bi bi-exclamation-triangle me-2"></i>{{ smsError }}
          </div>
        </div>
      </div>

      <!-- Search and Filter -->
      <div class="card custom-card mb-4">
        <div class="card-body">
          <div class="row align-items-end">
            <div class="col-md-8 mb-3 mb-md-0">
              <label for="searchInput" class="form-label fw-semibold">
                <i class="bi bi-search me-1"></i>Search Subscriptions
              </label>
              <input
                id="searchInput"
                ng-model="searchText"
                type="text"
                class="form-control form-control-custom"
                placeholder="Search by name, provider, or status..."
              />
            </div>
            <div class="col-md-4">
              <label for="statusFilter" class="form-label fw-semibold">
                <i class="bi bi-funnel me-1"></i>Filter by Status
              </label>
              <select
                id="statusFilter"
                ng-model="statusFilter"
                ng-change="filterSubscriptions()"
                class="form-select form-control-custom"
              >
                <option value="">All Subscriptions</option>
                <option value="active">Active Only</option>
                <option value="upcoming">Upcoming Only</option>
                <option value="expired">Expired Only</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Subscriptions Table -->
      <div class="card custom-card mb-4">
        <div class="card-header bg-transparent">
          <h4 class="mb-0">
            <i class="bi bi-list-ul me-2"></i>
            Your Subscriptions
            <span class="badge bg-primary ms-2"
              >{{ getFilteredSubscriptions().length }}</span
            >
          </h4>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-custom mb-0">
              <thead>
                <tr>
                  <th><i class="bi bi-tag me-1"></i>Name</th>
                  <th><i class="bi bi-currency-rupee me-1"></i>Cost</th>
                  <th><i class="bi bi-calendar-plus me-1"></i>Start Date</th>
                  <th><i class="bi bi-calendar-x me-1"></i>End Date</th>
                  <th><i class="bi bi-building me-1"></i>Provider</th>
                  <th><i class="bi bi-info-circle me-1"></i>Status</th>
                  <th><i class="bi bi-list me-1"></i>Cancel Steps</th>
                  <th><i class="bi bi-gear me-1"></i>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  ng-repeat="subscription in getFilteredSubscriptions() track by subscription._id"
                  class="slide-up"
                >
                  <td class="fw-semibold">{{ subscription.name }}</td>
                  <td class="currency">₹{{ subscription.cost | number:2 }}</td>
                  <td>
                    <small class="text-muted">
                      {{ subscription.startDate | date:'dd/MM/yyyy' }}
                    </small>
                  </td>
                  <td>
                    <span
                      ng-class="{'text-warning': isRenewalSoon(subscription), 'text-danger': isRenewalOverdue(subscription)}"
                    >
                      {{ subscription.endDate | date:'dd/MM/yyyy' }}
                    </span>
                    <br />
                    <small class="text-muted"
                      >{{ getRenewalStatus(subscription) }}</small
                    >
                  </td>
                  <td>{{ subscription.provider }}</td>
                  <td>
                    <span
                      class="badge status-badge"
                      ng-class="getStatusClass(subscription.status)"
                    >
                      {{ subscription.status | uppercase }}
                    </span>
                  </td>
                  <td>
                    <div ng-if="subscription.cancellationSteps">
                      <button
                        class="btn btn-sm btn-outline-info"
                        ng-click="showCancellationSteps(subscription)"
                        title="View cancellation steps"
                      >
                        <i class="bi bi-eye"></i>
                        <span class="d-none d-md-inline ms-1">View</span>
                      </button>
                    </div>
                    <div ng-if="!subscription.cancellationSteps">
                      <small class="text-muted">Not provided</small>
                    </div>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <button
                        ng-click="editSubscription(subscription)"
                        class="btn btn-sm btn-gradient-secondary"
                        title="Edit subscription"
                      >
                        <i class="bi bi-pencil"></i>
                        <span class="d-none d-md-inline ms-1">Edit</span>
                      </button>
                      <button
                        ng-click="confirmDelete(subscription)"
                        class="btn btn-sm btn-gradient-danger"
                        title="Delete subscription"
                      >
                        <i class="bi bi-trash"></i>
                        <span class="d-none d-md-inline ms-1">Delete</span>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr ng-if="getFilteredSubscriptions().length === 0">
                  <td colspan="8" class="text-center py-5 text-muted">
                    <i class="bi bi-inbox" style="font-size: 3rem"></i>
                    <div class="mt-2">
                      <strong>No subscriptions found</strong>
                      <div>
                        {{ searchText || statusFilter ? 'Try adjusting your
                        search or filter' : 'Add your first subscription above'
                        }}
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Monthly Cost Chart -->
      <div class="card custom-card">
        <div class="card-header bg-transparent">
          <h4 class="mb-0">
            <i class="bi bi-bar-chart me-2"></i>
            Subscription Costs by End Date
          </h4>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="costChart" style="max-height: 400px"></canvas>
          </div>
          <div class="mt-3 text-center">
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              Shows total subscription costs grouped by their end/renewal month
            </small>
          </div>
        </div>
      </div>

      <!-- Loading Overlay - Removed -->

      <!-- Delete Confirmation Modal -->
      <div
        ng-if="deleteConfirmation && deleteConfirmation.show"
        class="modal-backdrop fade show"
        style="z-index: 9998"
      ></div>
      <div
        ng-if="deleteConfirmation && deleteConfirmation.show"
        class="modal fade show d-block"
        style="z-index: 9999"
        tabindex="-1"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">
                <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                Confirm Deletion
              </h5>
            </div>
            <div class="modal-body">
              <div class="alert alert-warning">
                <i class="bi bi-warning me-2"></i>
                <strong>Warning:</strong> This action cannot be undone.
              </div>
              <p>Are you sure you want to delete the following subscription?</p>
              <div class="card bg-light">
                <div class="card-body py-2">
                  <strong>{{ deleteConfirmation.subscription.name }}</strong>
                  <br />
                  <small class="text-muted">
                    Provider: {{ deleteConfirmation.subscription.provider }} |
                    Cost: ₹{{ deleteConfirmation.subscription.cost }}
                  </small>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                ng-click="cancelDelete()"
              >
                <i class="bi bi-x-circle me-1"></i>
                Cancel
              </button>
              <button
                type="button"
                class="btn btn-danger"
                ng-click="deleteSubscription(deleteConfirmation.subscription._id)"
              >
                <i class="bi bi-trash me-1"></i>
                Delete Subscription
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Logger -->
    <script src="/js/logger.js"></script>

    <!-- AngularJS Application -->
    <script>
      angular
        .module("subscriptionApp", [])
        .controller("SubscriptionController", [
          "$scope",
          "$http",
          "$window",
          "$timeout",
          "$location",
          "$anchorScroll",
          function (
            $scope,
            $http,
            $window,
            $timeout,
            $location,
            $anchorScroll
          ) {
            // Initialize scope variables
            $scope.subscriptions = [];
            $scope.newSubscription = {};
            $scope.searchText = "";
            $scope.statusFilter = "";
            $scope.smsData = {};
            $scope.smsMessage = "";
            $scope.smsError = "";
            $scope.subscriptionError = "";
            $scope.subscriptionSuccess = "";
            $scope.dateRangeError = "";
            $scope.isLoading = false;
            $scope.isSubmitting = false;
            $scope.isSendingSMS = false;
            $scope.isTestingSMS = false;
            $scope.showDebug = localStorage.getItem("debugMode") === "true";
            $scope.deleteConfirmation = null; // For delete confirmation modal

            let token = localStorage.getItem("token");
            let chart;

            // Log controller initialization
            logger.info("Subscription app controller initialized");
            logger.markStart("app-load");

            // Check authentication
            if (!token) {
              logger.error("No authentication token found");
              $window.location.href = "/";
              return;
            }

            // Get display name from localStorage or decode from token
            $scope.getDisplayName = function () {
              const displayName = localStorage.getItem("displayName");
              if (displayName) {
                return displayName;
              }

              // Fallback: get from token and capitalize
              try {
                const payload = JSON.parse(atob(token.split(".")[1]));
                const username = payload.user || "User";
                return (
                  username.charAt(0).toUpperCase() +
                  username.slice(1).toLowerCase()
                );
              } catch (e) {
                return "User";
              }
            };

            // Get current user from token
            $scope.getCurrentUser = function () {
              try {
                const payload = JSON.parse(atob(token.split(".")[1]));
                return payload.user || "User";
              } catch (e) {
                return "User";
              }
            };

            // Get today's date in YYYY-MM-DD format
            $scope.getTodaysDate = function () {
              const today = new Date();
              return today.toISOString().split("T")[0];
            };

            // Utility function to format date for HTML input
            $scope.formatDateForInput = function (dateValue, fieldName) {
              if (!dateValue) {
                logger.warn(`${fieldName} is null or undefined`);
                return "";
              }

              try {
                let date;

                // Handle different date formats
                if (typeof dateValue === "string") {
                  // For string dates, parse them properly
                  date = new Date(dateValue + "T00:00:00.000Z"); // Add time to ensure UTC parsing
                } else if (dateValue instanceof Date) {
                  // Already a Date object
                  date = new Date(dateValue);
                } else {
                  // Try to convert other formats
                  date = new Date(dateValue);
                }

                // Validate the parsed date
                if (isNaN(date.getTime())) {
                  logger.error(`Invalid ${fieldName}:`, dateValue);
                  return fieldName === "startDate"
                    ? $scope.getTodaysDate()
                    : "";
                }

                // Create a new Date object adjusted for local timezone to avoid UTC issues
                const localDate = new Date(
                  date.getFullYear(),
                  date.getMonth(),
                  date.getDate()
                );

                // Format as YYYY-MM-DD for HTML input
                const year = localDate.getFullYear();
                const month = String(localDate.getMonth() + 1).padStart(2, "0");
                const day = String(localDate.getDate()).padStart(2, "0");
                const formattedDate = `${year}-${month}-${day}`;

                logger.info(`${fieldName} formatted:`, {
                  original: dateValue,
                  parsed: date.toISOString(),
                  localDate: localDate.toISOString(),
                  formatted: formattedDate,
                });

                return formattedDate;
              } catch (error) {
                logger.error(`Error formatting ${fieldName}:`, error);
                return fieldName === "startDate" ? $scope.getTodaysDate() : "";
              }
            };

            // Validate date range
            $scope.validateDateRange = function () {
              $scope.dateRangeError = "";

              if (
                $scope.newSubscription.startDate &&
                $scope.newSubscription.endDate
              ) {
                const startDate = new Date($scope.newSubscription.startDate);
                const endDate = new Date($scope.newSubscription.endDate);

                if (startDate >= endDate) {
                  $scope.dateRangeError = "End date must be after start date";
                }
              }
            };

            // Get subscription duration in months
            $scope.getSubscriptionDuration = function () {
              if (
                $scope.newSubscription.startDate &&
                $scope.newSubscription.endDate
              ) {
                const startDate = new Date($scope.newSubscription.startDate);
                const endDate = new Date($scope.newSubscription.endDate);

                const months =
                  (endDate.getFullYear() - startDate.getFullYear()) * 12 +
                  (endDate.getMonth() - startDate.getMonth()) +
                  1;
                return Math.max(1, months);
              }
              return 1;
            };

            // Update status options based on start date
            $scope.updateStatusOptions = function () {
              // Auto-set appropriate status based on dates
              $scope.autoSetStatusBasedOnDates();
            };

            // Automatically set the correct status based on dates
            $scope.autoSetStatusBasedOnDates = function () {
              if (
                !$scope.newSubscription.startDate ||
                !$scope.newSubscription.endDate
              ) {
                return;
              }

              if ($scope.isExpiredStatusAvailable()) {
                $scope.newSubscription.status = "expired";
              } else if ($scope.isUpcomingStatusAvailable()) {
                $scope.newSubscription.status = "upcoming";
              } else if ($scope.isActiveStatusAvailable()) {
                $scope.newSubscription.status = "active";
              }
            };

            // Handle status change events
            $scope.handleStatusChange = function () {
              // Ensure the selected status is valid for the current dates
              $scope.autoSetStatusBasedOnDates();
            };

            // Handle expired status when dates change
            $scope.handleExpiredStatus = function () {
              $scope.autoSetStatusBasedOnDates();
            };

            // Check if active status is available
            $scope.isActiveStatusAvailable = function () {
              if (
                !$scope.newSubscription.startDate ||
                !$scope.newSubscription.endDate
              )
                return false;

              const today = new Date();
              const startDate = new Date($scope.newSubscription.startDate);
              const endDate = new Date($scope.newSubscription.endDate);
              today.setHours(0, 0, 0, 0);
              startDate.setHours(0, 0, 0, 0);
              endDate.setHours(0, 0, 0, 0);

              // Active only if: start date <= today AND end date > today
              return startDate <= today && endDate > today;
            };

            // Check if upcoming status is available
            $scope.isUpcomingStatusAvailable = function () {
              if (!$scope.newSubscription.startDate) return false;

              const today = new Date();
              const startDate = new Date($scope.newSubscription.startDate);
              today.setHours(0, 0, 0, 0);
              startDate.setHours(0, 0, 0, 0);

              // Upcoming only if: start date > today
              return startDate > today;
            };

            // Check if expired status is available
            $scope.isExpiredStatusAvailable = function () {
              if (!$scope.newSubscription.endDate) return false;

              const today = new Date();
              const endDate = new Date($scope.newSubscription.endDate);
              today.setHours(0, 0, 0, 0);
              endDate.setHours(0, 0, 0, 0);

              // Expired only if: end date <= today
              return endDate <= today;
            };

            // Check if expired status should be forced or available (keeping for backward compatibility)
            $scope.isExpiredStatusForced = function () {
              return $scope.isExpiredStatusAvailable();
            };

            // Get status help text
            $scope.getStatusHelpText = function () {
              if (
                !$scope.newSubscription.startDate ||
                !$scope.newSubscription.endDate
              ) {
                return "Please select both start and end dates to see available status options";
              }

              const today = new Date();
              const startDate = new Date($scope.newSubscription.startDate);
              const endDate = new Date($scope.newSubscription.endDate);
              today.setHours(0, 0, 0, 0);
              startDate.setHours(0, 0, 0, 0);
              endDate.setHours(0, 0, 0, 0);

              if (endDate <= today) {
                return "This subscription has expired (end date has passed) - only 'Expired' status is available";
              } else if (startDate > today) {
                return "Start date is in the future - only 'Upcoming' status is available";
              } else {
                return "Subscription is currently active - only 'Active' status is available";
              }
            };

            // Clear or cancel form - set today's date as default
            $scope.clearOrCancel = function () {
              logger.logUserAction("clear-or-cancel-form");
              $scope.newSubscription = {
                startDate: new Date(), // Always set today's date as default using Date object
              };
              $scope.dateRangeError = "";
              $scope.subscriptionError = "";
              $scope.subscriptionSuccess = "";
            };

            // Load subscriptions on init
            $scope.loadSubscriptions = function () {
              logger.info("Loading subscriptions");
              $scope.isLoading = true;

              $http({
                method: "GET",
                url: "/api/subscriptions",
                headers: { Authorization: "Bearer " + token },
              }).then(
                function (response) {
                  $scope.subscriptions = response.data;
                  $scope.isLoading = false;
                  logger.info(`Loaded ${response.data.length} subscriptions`);

                  // Auto-update statuses before displaying
                  $scope.autoUpdateSubscriptionStatuses();

                  $timeout(() => $scope.updateChart(), 200); // Increased timeout to allow status updates
                  logger.markEnd("app-load");
                },
                function (error) {
                  logger.error("Failed to load subscriptions", {
                    error: error.data,
                  });
                  $scope.isLoading = false;

                  // Handle authentication errors and server unavailability
                  if (error.status === 401 || error.status === 403) {
                    logger.error(
                      "Authentication failed - token may be invalid"
                    );
                    $scope.handleServerUnavailable();
                  } else if (error.status === 0 || error.status === -1) {
                    logger.error("Server unavailable - network error");
                    $scope.handleServerUnavailable();
                  }
                }
              );
            };

            // Logout function
            $scope.logout = function () {
              logger.info("User logout initiated");
              localStorage.removeItem("token");
              localStorage.removeItem("currentUser");
              localStorage.removeItem("displayName");
              $scope.subscriptions = [];
              $scope.newSubscription = {};
              $scope.searchText = "";
              $scope.statusFilter = "";
              $window.location.href = "/";
            };

            // Save subscription (Add or Update)
            $scope.saveSubscription = function () {
              logger.info("Saving subscription", {
                name: $scope.newSubscription.name,
                isUpdate: !!$scope.newSubscription._id,
              });

              $scope.isSubmitting = true;
              $scope.subscriptionError = "";
              $scope.subscriptionSuccess = "";

              // Validate required fields
              const requiredFields = [
                $scope.newSubscription.name,
                $scope.newSubscription.cost,
                $scope.newSubscription.startDate,
                $scope.newSubscription.endDate,
                $scope.newSubscription.provider,
                $scope.newSubscription.status,
              ];

              if (requiredFields.some((field) => !field)) {
                $scope.subscriptionError = "Please fill all required fields!";
                $scope.isSubmitting = false;
                logger.logFormValidation("subscription-form", false, [
                  "missing-required-fields",
                ]);
                return;
              }

              // Validate date range
              $scope.validateDateRange();
              if ($scope.dateRangeError) {
                $scope.subscriptionError = $scope.dateRangeError;
                $scope.isSubmitting = false;
                logger.logFormValidation("subscription-form", false, [
                  "invalid-date-range",
                ]);
                return;
              }

              // Validate all dates are in 2025 - REMOVED
              // No longer restricting dates to specific year

              // Set renewal date to end date (since end date is the renewal date)
              $scope.newSubscription.renewalDate =
                $scope.newSubscription.endDate;

              logger.logFormValidation("subscription-form", true);

              const method = $scope.newSubscription._id ? "PUT" : "POST";
              const url = $scope.newSubscription._id
                ? "/api/subscriptions/" + $scope.newSubscription._id
                : "/api/subscriptions";

              const startTime = Date.now();
              $http({
                method: method,
                url: url,
                data: $scope.newSubscription,
                headers: { Authorization: "Bearer " + token },
              }).then(
                function (response) {
                  const duration = Date.now() - startTime;
                  const isUpdate = !!$scope.newSubscription._id;

                  logger.logRequest(method, url, 200, duration);
                  logger.info(
                    `Subscription ${
                      isUpdate ? "updated" : "added"
                    } successfully`
                  );

                  $scope.loadSubscriptions();
                  $scope.subscriptionSuccess = isUpdate
                    ? "Subscription updated successfully!"
                    : "Subscription added successfully!";

                  $scope.newSubscription = {};
                  $scope.dateRangeError = "";
                  $scope.isSubmitting = false;

                  // Clear success message after 3 seconds
                  $timeout(() => {
                    $scope.subscriptionSuccess = "";
                  }, 3000);
                },
                function (error) {
                  const duration = Date.now() - startTime;
                  logger.logRequest(method, url, error.status, duration);
                  logger.error("Failed to save subscription", {
                    error: error.data,
                  });

                  $scope.subscriptionError =
                    "Failed to " +
                    ($scope.newSubscription._id ? "update" : "add") +
                    " subscription!";
                  $scope.isSubmitting = false;
                }
              );
            };

            // Edit subscription - preserve original dates exactly as they were
            $scope.editSubscription = function (subscription) {
              logger.logUserAction("edit-subscription", null, {
                subscriptionId: subscription._id,
              });

              // Log the subscription data we're editing
              logger.info("Editing subscription:", {
                id: subscription._id,
                name: subscription.name,
                originalStartDate: subscription.startDate,
                originalEndDate: subscription.endDate,
                startDateType: typeof subscription.startDate,
                endDateType: typeof subscription.endDate,
              });

              // Make a deep copy of the subscription
              $scope.newSubscription = angular.copy(subscription);

              // Handle date conversion for AngularJS compatibility
              try {
                // For start date
                if (subscription.startDate) {
                  const startDate = new Date(subscription.startDate);
                  if (!isNaN(startDate.getTime())) {
                    // Create a clean Date object for the local date (no time component)
                    $scope.newSubscription.startDate = new Date(
                      startDate.getFullYear(),
                      startDate.getMonth(),
                      startDate.getDate()
                    );
                    logger.info(
                      "Start date set as Date object:",
                      $scope.newSubscription.startDate
                    );
                  } else {
                    $scope.newSubscription.startDate = new Date();
                    logger.error(
                      "Invalid start date, using today:",
                      subscription.startDate
                    );
                  }
                }

                // For end date
                if (subscription.endDate) {
                  const endDate = new Date(subscription.endDate);
                  if (!isNaN(endDate.getTime())) {
                    // Create a clean Date object for the local date (no time component)
                    $scope.newSubscription.endDate = new Date(
                      endDate.getFullYear(),
                      endDate.getMonth(),
                      endDate.getDate()
                    );
                    logger.info(
                      "End date set as Date object:",
                      $scope.newSubscription.endDate
                    );
                  } else {
                    $scope.newSubscription.endDate = null;
                    logger.error("Invalid end date:", subscription.endDate);
                  }
                }

                // Log the final formatted values
                logger.info("Edit form populated with dates:", {
                  startDate: $scope.newSubscription.startDate,
                  endDate: $scope.newSubscription.endDate,
                  startDateType: typeof $scope.newSubscription.startDate,
                  endDateType: typeof $scope.newSubscription.endDate,
                });
              } catch (error) {
                logger.error("Error processing dates for edit:", error);
                $scope.newSubscription.startDate = new Date();
                $scope.newSubscription.endDate = null;
              }

              // Use $timeout to ensure AngularJS properly handles the date assignment
              $timeout(function () {
                // Update status options based on dates and auto-set appropriate status
                $scope.updateStatusOptions();
                $scope.autoSetStatusBasedOnDates();
              }, 0);

              // Clear any existing errors
              $scope.dateRangeError = "";
              $scope.subscriptionError = "";
              $scope.subscriptionSuccess = "";

              // Scroll to form
              $scope.scrollToElement("subName");
            };

            // Confirm delete subscription
            $scope.confirmDelete = function (subscription) {
              $scope.deleteConfirmation = {
                subscription: subscription,
                show: true,
              };
            };

            // Cancel delete
            $scope.cancelDelete = function () {
              $scope.deleteConfirmation = null;
            };

            // Delete subscription
            $scope.deleteSubscription = function (id) {
              logger.logUserAction("delete-subscription", null, {
                subscriptionId: id,
              });

              const startTime = Date.now();
              $http({
                method: "DELETE",
                url: "/api/subscriptions/" + id,
                headers: { Authorization: "Bearer " + token },
              }).then(
                function () {
                  const duration = Date.now() - startTime;
                  logger.logRequest(
                    "DELETE",
                    `/api/subscriptions/${id}`,
                    200,
                    duration
                  );
                  logger.info("Subscription deleted successfully");
                  $scope.loadSubscriptions();
                  $scope.deleteConfirmation = null; // Close confirmation
                },
                function (error) {
                  const duration = Date.now() - startTime;
                  logger.logRequest(
                    "DELETE",
                    `/api/subscriptions/${id}`,
                    error.status,
                    duration
                  );
                  logger.error("Failed to delete subscription", {
                    error: error.data,
                  });
                  $scope.deleteConfirmation = null; // Close confirmation
                }
              );
            };

            // Show cancellation steps
            $scope.showCancellationSteps = function (subscription) {
              const modal = `
                <div class="modal fade" id="cancellationModal" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">
                          <i class="bi bi-list me-2"></i>
                          Cancellation Steps - ${subscription.name}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <div class="alert alert-info">
                          <i class="bi bi-info-circle me-2"></i>
                          How to cancel your ${subscription.name} subscription:
                        </div>
                        <div class="cancellation-steps">
                          ${subscription.cancellationSteps.replace(
                            /\n/g,
                            "<br>"
                          )}
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
              `;

              // Remove existing modal
              const existingModal =
                document.getElementById("cancellationModal");
              if (existingModal) {
                existingModal.remove();
              }

              // Add new modal
              document.body.insertAdjacentHTML("beforeend", modal);

              // Show modal
              const modalElement = new bootstrap.Modal(
                document.getElementById("cancellationModal")
              );
              modalElement.show();
            };

            // Clear SMS form
            $scope.clearSMS = function () {
              logger.logUserAction("clear-sms-form");
              $scope.smsData = {};
              $scope.smsError = "";
              $scope.smsMessage = "";
            };

            // Test SMS reminders
            $scope.testSMSReminders = function () {
              logger.info("Testing SMS reminders");

              $scope.isTestingSMS = true;
              $scope.smsError = "";
              $scope.smsMessage = "";

              const startTime = Date.now();
              $http({
                method: "POST",
                url: "/api/test-sms-reminders",
                headers: { Authorization: "Bearer " + token },
              }).then(
                function (response) {
                  const duration = Date.now() - startTime;
                  logger.logRequest(
                    "POST",
                    "/api/test-sms-reminders",
                    200,
                    duration
                  );
                  logger.info("SMS reminders test completed", response.data);

                  const results = response.data.results;
                  const summary = response.data.summary;

                  let message = `SMS Test Complete! `;
                  message += `Sent ${summary.expiredReminders} expired reminders, `;
                  message += `${summary.upcomingReminders} upcoming reminders. `;

                  if (summary.errors > 0) {
                    message += `${summary.errors} errors occurred.`;
                    $scope.smsError = message;
                  } else {
                    $scope.smsMessage = message;
                  }

                  $scope.isTestingSMS = false;

                  $timeout(() => {
                    $scope.smsMessage = "";
                    $scope.smsError = "";
                  }, 10000); // Show results for 10 seconds
                },
                function (error) {
                  const duration = Date.now() - startTime;
                  logger.logRequest(
                    "POST",
                    "/api/test-sms-reminders",
                    error.status,
                    duration
                  );
                  logger.error("SMS reminders test failed", {
                    error: error.data,
                  });

                  $scope.smsError =
                    error.data?.message || "SMS reminders test failed";
                  $scope.isTestingSMS = false;

                  $timeout(() => {
                    $scope.smsError = "";
                  }, 5000);
                }
              );
            };

            // Send SMS
            $scope.sendSMS = function () {
              logger.info("Sending SMS", { to: $scope.smsData.to });

              $scope.isSendingSMS = true;
              $scope.smsError = "";
              $scope.smsMessage = "";

              if (!$scope.smsData.to || !$scope.smsData.body) {
                $scope.smsError = "Please fill all SMS fields!";
                $scope.isSendingSMS = false;
                return;
              }

              const startTime = Date.now();
              $http({
                method: "POST",
                url: "/api/send-sms",
                data: $scope.smsData,
                headers: { Authorization: "Bearer " + token },
              }).then(
                function (response) {
                  const duration = Date.now() - startTime;
                  logger.logRequest("POST", "/api/send-sms", 200, duration);
                  logger.info("SMS sent successfully");

                  $scope.smsMessage = "SMS sent successfully";
                  $scope.smsData = {};
                  $scope.isSendingSMS = false;

                  $timeout(() => {
                    $scope.smsMessage = "";
                  }, 3000);
                },
                function (error) {
                  const duration = Date.now() - startTime;
                  logger.logRequest(
                    "POST",
                    "/api/send-sms",
                    error.status,
                    duration
                  );
                  logger.error("Failed to send SMS", { error: error.data });

                  $scope.smsError = error.data?.message || "Failed to send SMS";
                  $scope.isSendingSMS = false;
                }
              );
            };

            // Keyboard navigation
            $scope.moveToNextField = function (event, currentIndex, formType) {
              if (event.keyCode === 13) {
                event.preventDefault();

                let formFields;
                if (formType === "sms") {
                  formFields = ["smsPhone", "smsMessage"];
                } else {
                  formFields = [
                    "subName",
                    "subCost",
                    "subStartDate",
                    "subEndDate",
                    "subProvider",
                    "subStatus",
                    "subCancel",
                  ];
                }

                if (currentIndex < formFields.length - 1) {
                  document
                    .getElementById(formFields[currentIndex + 1])
                    ?.focus();
                } else {
                  if (formType === "sms") {
                    $scope.sendSMS();
                  } else {
                    $scope.saveSubscription();
                  }
                }
              }
            };

            // Utility functions with smart status detection
            $scope.getActiveSubscriptions = function () {
              const today = new Date();
              today.setHours(0, 0, 0, 0);

              return $scope.subscriptions.filter((sub) => {
                const startDate = new Date(sub.startDate);
                const endDate = new Date(sub.endDate);
                startDate.setHours(0, 0, 0, 0);
                endDate.setHours(0, 0, 0, 0);

                // Active if: status is 'active' OR should be active based on dates
                return (
                  (sub.status === "active" && endDate > today) ||
                  (startDate <= today &&
                    endDate > today &&
                    sub.status !== "expired")
                );
              });
            };

            $scope.getUpcomingSubscriptions = function () {
              const today = new Date();
              today.setHours(0, 0, 0, 0);

              return $scope.subscriptions.filter((sub) => {
                const startDate = new Date(sub.startDate);
                startDate.setHours(0, 0, 0, 0);

                // Upcoming if: status is 'upcoming' OR should be upcoming based on dates
                return (
                  (sub.status === "upcoming" && startDate > today) ||
                  (startDate > today && sub.status !== "expired")
                );
              });
            };

            $scope.getExpiredSubscriptions = function () {
              const today = new Date();
              today.setHours(0, 0, 0, 0);

              return $scope.subscriptions.filter((sub) => {
                const endDate = new Date(sub.endDate);
                endDate.setHours(0, 0, 0, 0);

                // Expired if: status is 'expired' OR should be expired based on dates
                return sub.status === "expired" || endDate <= today;
              });
            };

            // Keep the old function for backward compatibility
            $scope.getCanceledSubscriptions = function () {
              return $scope.getExpiredSubscriptions();
            };

            $scope.getUpcomingRenewals = function () {
              const today = new Date();
              const nextWeek = new Date();
              nextWeek.setDate(today.getDate() + 7);

              return $scope.getActiveSubscriptions().filter((sub) => {
                const endDate = new Date(sub.endDate);
                return endDate >= today && endDate <= nextWeek;
              });
            };

            $scope.getTotalMonthlyCost = function () {
              return $scope
                .getActiveSubscriptions()
                .reduce((total, sub) => total + (sub.cost || 0), 0);
            };

            $scope.getFilteredSubscriptions = function () {
              let filtered = $scope.subscriptions;

              if ($scope.searchText) {
                const search = $scope.searchText.toLowerCase();
                filtered = filtered.filter(
                  (sub) =>
                    sub.name.toLowerCase().includes(search) ||
                    sub.provider.toLowerCase().includes(search) ||
                    sub.status.toLowerCase().includes(search)
                );
              }

              if ($scope.statusFilter) {
                filtered = filtered.filter(
                  (sub) => sub.status === $scope.statusFilter
                );
              }

              return filtered;
            };

            $scope.getStatusClass = function (status) {
              switch (status) {
                case "active":
                  return "status-active";
                case "upcoming":
                  return "status-upcoming";
                case "expired":
                  return "status-expired";
                case "canceled": // Keep for backward compatibility
                  return "status-expired";
                default:
                  return "";
              }
            };

            $scope.isRenewalSoon = function (subscription) {
              const today = new Date();
              const endDate = new Date(subscription.endDate);
              const daysDiff = Math.ceil(
                (endDate - today) / (1000 * 60 * 60 * 24)
              );
              return daysDiff <= 7 && daysDiff > 0;
            };

            $scope.isRenewalOverdue = function (subscription) {
              const today = new Date();
              const endDate = new Date(subscription.endDate);
              return endDate < today && subscription.status === "active";
            };

            $scope.getRenewalStatus = function (subscription) {
              const today = new Date();
              const endDate = new Date(subscription.endDate);
              const daysDiff = Math.ceil(
                (endDate - today) / (1000 * 60 * 60 * 24)
              );

              if (daysDiff < 0) return "Overdue";
              if (daysDiff === 0) return "Today";
              if (daysDiff === 1) return "Tomorrow";
              if (daysDiff <= 7) return `${daysDiff} days`;
              return `${Math.ceil(daysDiff / 7)} weeks`;
            };

            // Chart update function
            $scope.updateChart = function () {
              const monthlyCosts = new Array(12).fill(0);

              $scope.getActiveSubscriptions().forEach((sub) => {
                const endDate = new Date(sub.endDate);
                const cost = sub.cost || 0;

                // Add the full subscription cost to the end month only (any year)
                monthlyCosts[endDate.getMonth()] += cost;
              });

              const ctx = document.getElementById("costChart").getContext("2d");
              if (chart) chart.destroy();

              chart = new Chart(ctx, {
                type: "bar",
                data: {
                  labels: [
                    "Jan",
                    "Feb",
                    "Mar",
                    "Apr",
                    "May",
                    "Jun",
                    "Jul",
                    "Aug",
                    "Sep",
                    "Oct",
                    "Nov",
                    "Dec",
                  ],
                  datasets: [
                    {
                      label: "Subscription Costs (₹)",
                      data: monthlyCosts,
                      backgroundColor: "rgba(102, 126, 234, 0.8)",
                      borderColor: "rgba(102, 126, 234, 1)",
                      borderWidth: 2,
                      borderRadius: 8,
                      borderSkipped: false,
                    },
                  ],
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      display: false,
                    },
                    tooltip: {
                      callbacks: {
                        label: function (context) {
                          return `Total Cost: ₹${context.parsed.y.toLocaleString()}`;
                        },
                      },
                    },
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function (value) {
                          return "₹" + value.toLocaleString();
                        },
                      },
                    },
                  },
                },
              });
            };

            // Scroll to element
            $scope.scrollToElement = function (elementId) {
              $timeout(() => {
                const element = document.getElementById(elementId);
                if (element) {
                  element.scrollIntoView({
                    behavior: "smooth",
                    block: "start",
                  });
                  element.focus();
                }
              }, 100);
            };

            // Debug mode toggle
            document.addEventListener("keydown", function (event) {
              if (event.ctrlKey && event.shiftKey && event.key === "D") {
                event.preventDefault();
                $scope.$apply(function () {
                  $scope.showDebug = !$scope.showDebug;
                  localStorage.setItem(
                    "debugMode",
                    $scope.showDebug.toString()
                  );
                  logger.info("Debug mode toggled", {
                    enabled: $scope.showDebug,
                  });
                });
              }

              // Add Ctrl+Shift+I to inspect subscription data
              if (event.ctrlKey && event.shiftKey && event.key === "I") {
                event.preventDefault();
                $scope.$apply(function () {
                  logger.info("=== SUBSCRIPTION DATA INSPECTION ===");
                  $scope.subscriptions.forEach((sub, index) => {
                    logger.info(`Subscription ${index + 1}:`, {
                      name: sub.name,
                      startDate: sub.startDate,
                      endDate: sub.endDate,
                      startDateType: typeof sub.startDate,
                      endDateType: typeof sub.endDate,
                      status: sub.status,
                    });
                  });
                  logger.info("=== END INSPECTION ===");
                  alert(
                    "Subscription data logged to console. Open browser dev tools to view."
                  );
                });
              }
            });

            // Initialize app
            $scope.loadSubscriptions();

            // Set today's date as default for new subscriptions - always initialize with current date
            $scope.newSubscription = {
              startDate: new Date(), // Use Date object instead of string for AngularJS compatibility
            };

            // Auto-logout when server is unavailable or token is invalid
            $scope.handleServerUnavailable = function () {
              logger.error(
                "Server unavailable or token invalid - logging out user"
              );
              localStorage.removeItem("token");
              localStorage.removeItem("currentUser");
              localStorage.removeItem("displayName");

              // Direct redirect to login page
              $window.location.href = "/";
            };

            // Auto-update subscription statuses based on dates on load
            $scope.autoUpdateSubscriptionStatuses = function () {
              const today = new Date();
              today.setHours(0, 0, 0, 0);

              let updatesNeeded = false;

              $scope.subscriptions.forEach((sub) => {
                const startDate = new Date(sub.startDate);
                const endDate = new Date(sub.endDate);
                startDate.setHours(0, 0, 0, 0);
                endDate.setHours(0, 0, 0, 0);

                let newStatus = sub.status;

                // Determine what the status should be based on dates
                if (endDate <= today) {
                  newStatus = "expired";
                } else if (startDate > today) {
                  newStatus = "upcoming";
                } else if (startDate <= today && endDate > today) {
                  newStatus = "active";
                }

                // If status needs to change, update it
                if (newStatus !== sub.status) {
                  logger.info(
                    `Auto-updating subscription ${sub.name} status from ${sub.status} to ${newStatus}`
                  );
                  sub.status = newStatus;
                  updatesNeeded = true;

                  // Update on server
                  $http({
                    method: "PUT",
                    url: "/api/subscriptions/" + sub._id,
                    data: sub,
                    headers: { Authorization: "Bearer " + token },
                  }).then(
                    function (response) {
                      logger.info(
                        `Successfully updated subscription ${sub.name} status to ${newStatus}`
                      );
                    },
                    function (error) {
                      logger.error(
                        `Failed to update subscription ${sub.name} status`,
                        { error: error.data }
                      );
                      // Revert the status change if server update failed
                      sub.status = sub.status; // This will be the old status
                    }
                  );
                }
              });

              if (updatesNeeded) {
                // Refresh the chart and UI after status updates
                $timeout(() => $scope.updateChart(), 100);
              }
            };

            // Log when user leaves the page
            window.addEventListener("beforeunload", function () {
              logger.info("User leaving subscription manager app");
            });
          },
        ]);
    </script>
  </body>
</html>
