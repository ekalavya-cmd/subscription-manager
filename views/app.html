<!DOCTYPE html>
<html lang="en" ng-app="subscriptionApp">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subscription Manager</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- AngularJS -->
    <script src="https://code.angularjs.org/1.8.2/angular.min.js"></script>

    <!-- Custom CSS -->
    <link href="/css/custom.css" rel="stylesheet" />
  </head>
  <body>
    <div ng-controller="SubscriptionController" class="container-fluid py-3">
      <!-- Header Navigation -->
      <nav class="navbar navbar-expand-lg navbar-custom mb-4">
        <div class="container-fluid">
          <div class="navbar-brand d-flex align-items-center">
            <i
              class="bi bi-calendar-check text-primary me-2"
              style="font-size: 1.5rem"
            ></i>
            <span class="fw-bold text-dark">Subscription Manager</span>
          </div>

          <div class="d-flex align-items-center">
            <div class="me-3">
              <small class="text-muted">Welcome back!</small>
              <div class="fw-semibold">{{ getCurrentUser() }}</div>
            </div>

            <!-- Debug Button -->
            <button
              ng-if="showDebug"
              type="button"
              class="btn btn-sm btn-outline-secondary me-2"
              onclick="logger.showLogsModal()"
            >
              <i class="bi bi-bug"></i>
            </button>

            <!-- Logout Button -->
            <button ng-click="logout()" class="btn btn-gradient-danger">
              <i class="bi bi-box-arrow-right me-2"></i>
              Logout
            </button>
          </div>
        </div>
      </nav>

      <!-- Dashboard Stats -->
      <div class="row mb-4">
        <div class="col-md-3 mb-3">
          <div class="card custom-card h-100">
            <div class="card-body text-center">
              <i
                class="bi bi-graph-up text-success"
                style="font-size: 2rem"
              ></i>
              <h5 class="card-title mt-2 mb-1">Total Active</h5>
              <h3 class="text-success mb-0">
                {{ getActiveSubscriptions().length }}
              </h3>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card custom-card h-100">
            <div class="card-body text-center">
              <i
                class="bi bi-currency-rupee text-primary"
                style="font-size: 2rem"
              ></i>
              <h5 class="card-title mt-2 mb-1">Monthly Cost</h5>
              <h3 class="text-primary mb-0">
                ₹{{ getTotalMonthlyCost() | number:0 }}
              </h3>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card custom-card h-100">
            <div class="card-body text-center">
              <i class="bi bi-clock text-warning" style="font-size: 2rem"></i>
              <h5 class="card-title mt-2 mb-1">Upcoming</h5>
              <h3 class="text-warning mb-0">
                {{ getUpcomingRenewals().length }}
              </h3>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card custom-card h-100">
            <div class="card-body text-center">
              <i class="bi bi-x-circle text-danger" style="font-size: 2rem"></i>
              <h5 class="card-title mt-2 mb-1">Canceled</h5>
              <h3 class="text-danger mb-0">
                {{ getCanceledSubscriptions().length }}
              </h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Subscription Form -->
      <div class="card custom-card mb-4">
        <div class="card-header bg-transparent">
          <h4 class="mb-0">
            <i class="bi bi-plus-circle me-2"></i>
            {{ newSubscription._id ? 'Edit Subscription' : 'Add New
            Subscription' }}
          </h4>
        </div>
        <div class="card-body">
          <form
            ng-submit="saveSubscription()"
            novalidate
            name="subscriptionForm"
          >
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="subName" class="form-label fw-semibold">
                  <i class="bi bi-tag me-1"></i>Service Name
                </label>
                <input
                  id="subName"
                  ng-model="newSubscription.name"
                  type="text"
                  class="form-control form-control-custom"
                  placeholder="e.g., Netflix, Spotify"
                  required
                  ng-keypress="moveToNextField($event, 0)"
                  name="name"
                />
              </div>

              <div class="col-md-6 mb-3">
                <label for="subCost" class="form-label fw-semibold">
                  <i class="bi bi-currency-rupee me-1"></i>Monthly Cost (₹)
                </label>
                <input
                  id="subCost"
                  ng-model="newSubscription.cost"
                  type="number"
                  class="form-control form-control-custom"
                  placeholder="199"
                  required
                  min="0"
                  step="0.01"
                  ng-keypress="moveToNextField($event, 1)"
                  name="cost"
                />
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="subRenewal" class="form-label fw-semibold">
                  <i class="bi bi-calendar me-1"></i>Next Renewal Date
                </label>
                <input
                  id="subRenewal"
                  ng-model="newSubscription.renewalDate"
                  type="date"
                  class="form-control form-control-custom"
                  required
                  ng-keypress="moveToNextField($event, 2)"
                  name="renewalDate"
                />
              </div>

              <div class="col-md-6 mb-3">
                <label for="subProvider" class="form-label fw-semibold">
                  <i class="bi bi-building me-1"></i>Provider
                </label>
                <input
                  id="subProvider"
                  ng-model="newSubscription.provider"
                  type="text"
                  class="form-control form-control-custom"
                  placeholder="e.g., Netflix Inc."
                  required
                  ng-keypress="moveToNextField($event, 3)"
                  name="provider"
                />
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="subStatus" class="form-label fw-semibold">
                  <i class="bi bi-info-circle me-1"></i>Status
                </label>
                <select
                  id="subStatus"
                  ng-model="newSubscription.status"
                  class="form-select form-control-custom"
                  required
                  ng-keypress="moveToNextField($event, 4)"
                  name="status"
                >
                  <option value="">Select Status</option>
                  <option value="active">Active</option>
                  <option value="upcoming">Upcoming</option>
                  <option value="canceled">Canceled</option>
                </select>
              </div>

              <div class="col-md-6 mb-3">
                <label for="subCancel" class="form-label fw-semibold">
                  <i class="bi bi-list me-1"></i>Cancellation Steps (Optional)
                </label>
                <textarea
                  id="subCancel"
                  ng-model="newSubscription.cancellationSteps"
                  class="form-control form-control-custom"
                  placeholder="How to cancel this subscription..."
                  rows="3"
                  ng-keypress="moveToNextField($event, 5)"
                  name="cancellationSteps"
                ></textarea>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <button
                  type="submit"
                  class="btn btn-gradient-primary btn-lg w-100 mb-2"
                  ng-disabled="subscriptionForm.$invalid || isSubmitting"
                >
                  <span
                    ng-if="isSubmitting"
                    class="spinner-border spinner-border-sm me-2"
                  ></span>
                  <i class="bi bi-check-circle me-2" ng-if="!isSubmitting"></i>
                  {{ isSubmitting ? 'Saving...' : (newSubscription._id ? 'Update
                  Subscription' : 'Add Subscription') }}
                </button>
              </div>
              <div class="col-md-6">
                <button
                  type="button"
                  ng-click="clearOrCancel()"
                  class="btn btn-gradient-secondary btn-lg w-100 mb-2"
                >
                  <i class="bi bi-x-circle me-2"></i>
                  {{ newSubscription._id ? 'Cancel Edit' : 'Clear Form' }}
                </button>
              </div>
            </div>
          </form>

          <!-- Form Messages -->
          <div
            ng-if="subscriptionSuccess"
            class="alert alert-custom-success mt-3 fade-in"
          >
            <i class="bi bi-check-circle me-2"></i>{{ subscriptionSuccess }}
          </div>
          <div
            ng-if="subscriptionError"
            class="alert alert-custom-danger mt-3 fade-in"
          >
            <i class="bi bi-exclamation-triangle me-2"></i>{{ subscriptionError
            }}
          </div>
        </div>
      </div>

      <!-- SMS Reminder Section -->
      <div class="card custom-card mb-4">
        <div class="card-header bg-transparent">
          <h4 class="mb-0">
            <i class="bi bi-chat-dots me-2"></i>
            Send SMS Reminder
          </h4>
        </div>
        <div class="card-body">
          <form ng-submit="sendSMS()" novalidate name="smsForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="smsPhone" class="form-label fw-semibold">
                  <i class="bi bi-phone me-1"></i>Phone Number
                </label>
                <input
                  id="smsPhone"
                  ng-model="smsData.to"
                  type="tel"
                  class="form-control form-control-custom"
                  placeholder="+919876543210"
                  required
                  pattern="^\+[1-9]\d{9,14}$"
                  ng-keypress="moveToNextField($event, 0, 'sms')"
                  name="phone"
                />
                <div class="form-text">
                  <i class="bi bi-info-circle me-1"></i>
                  Use E.164 format (e.g., +919876543210)
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="smsMessage" class="form-label fw-semibold">
                  <i class="bi bi-chat-text me-1"></i>Message
                </label>
                <textarea
                  id="smsMessage"
                  ng-model="smsData.body"
                  class="form-control form-control-custom"
                  placeholder="Your subscription reminder message..."
                  required
                  rows="3"
                  ng-keypress="moveToNextField($event, 1, 'sms')"
                  name="message"
                ></textarea>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <button
                  type="submit"
                  class="btn btn-gradient-primary btn-lg w-100 mb-2"
                  ng-disabled="smsForm.$invalid || isSendingSMS"
                >
                  <span
                    ng-if="isSendingSMS"
                    class="spinner-border spinner-border-sm me-2"
                  ></span>
                  <i class="bi bi-send me-2" ng-if="!isSendingSMS"></i>
                  {{ isSendingSMS ? 'Sending...' : 'Send SMS' }}
                </button>
              </div>
              <div class="col-md-6">
                <button
                  type="button"
                  ng-click="clearSMS()"
                  class="btn btn-gradient-secondary btn-lg w-100 mb-2"
                >
                  <i class="bi bi-x-circle me-2"></i>
                  Clear SMS Form
                </button>
              </div>
            </div>
          </form>

          <!-- SMS Messages -->
          <div
            ng-if="smsMessage"
            class="alert alert-custom-success mt-3 fade-in"
          >
            <i class="bi bi-check-circle me-2"></i>{{ smsMessage }}
          </div>
          <div ng-if="smsError" class="alert alert-custom-danger mt-3 fade-in">
            <i class="bi bi-exclamation-triangle me-2"></i>{{ smsError }}
          </div>
        </div>
      </div>

      <!-- Search and Filter -->
      <div class="card custom-card mb-4">
        <div class="card-body">
          <div class="row align-items-end">
            <div class="col-md-8 mb-3 mb-md-0">
              <label for="searchInput" class="form-label fw-semibold">
                <i class="bi bi-search me-1"></i>Search Subscriptions
              </label>
              <input
                id="searchInput"
                ng-model="searchText"
                type="text"
                class="form-control form-control-custom"
                placeholder="Search by name, provider, or status..."
              />
            </div>
            <div class="col-md-4">
              <label for="statusFilter" class="form-label fw-semibold">
                <i class="bi bi-funnel me-1"></i>Filter by Status
              </label>
              <select
                id="statusFilter"
                ng-model="statusFilter"
                ng-change="filterSubscriptions()"
                class="form-select form-control-custom"
              >
                <option value="">All Subscriptions</option>
                <option value="active">Active Only</option>
                <option value="upcoming">Upcoming Only</option>
                <option value="canceled">Canceled Only</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Subscriptions Table -->
      <div class="card custom-card mb-4">
        <div class="card-header bg-transparent">
          <h4 class="mb-0">
            <i class="bi bi-list-ul me-2"></i>
            Your Subscriptions
            <span class="badge bg-primary ms-2"
              >{{ getFilteredSubscriptions().length }}</span
            >
          </h4>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-custom mb-0">
              <thead>
                <tr>
                  <th><i class="bi bi-tag me-1"></i>Name</th>
                  <th><i class="bi bi-currency-rupee me-1"></i>Cost</th>
                  <th><i class="bi bi-calendar me-1"></i>Renewal Date</th>
                  <th><i class="bi bi-building me-1"></i>Provider</th>
                  <th><i class="bi bi-info-circle me-1"></i>Status</th>
                  <th><i class="bi bi-gear me-1"></i>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  ng-repeat="subscription in getFilteredSubscriptions() track by subscription._id"
                  class="slide-up"
                >
                  <td class="fw-semibold">{{ subscription.name }}</td>
                  <td class="currency">₹{{ subscription.cost | number:2 }}</td>
                  <td>
                    <span
                      ng-class="{'text-warning': isRenewalSoon(subscription), 'text-danger': isRenewalOverdue(subscription)}"
                    >
                      {{ subscription.renewalDate | date:'mediumDate' }}
                    </span>
                    <br />
                    <small class="text-muted"
                      >{{ getRenewalStatus(subscription) }}</small
                    >
                  </td>
                  <td>{{ subscription.provider }}</td>
                  <td>
                    <span
                      class="badge status-badge"
                      ng-class="getStatusClass(subscription.status)"
                    >
                      {{ subscription.status | uppercase }}
                    </span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <button
                        ng-click="editSubscription(subscription)"
                        class="btn btn-sm btn-gradient-secondary"
                        title="Edit subscription"
                      >
                        <i class="bi bi-pencil"></i>
                        <span class="d-none d-md-inline ms-1">Edit</span>
                      </button>
                      <button
                        ng-click="deleteSubscription(subscription._id)"
                        class="btn btn-sm btn-gradient-danger"
                        title="Delete subscription"
                        onclick="return confirm('Are you sure you want to delete this subscription?')"
                      >
                        <i class="bi bi-trash"></i>
                        <span class="d-none d-md-inline ms-1">Delete</span>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr ng-if="getFilteredSubscriptions().length === 0">
                  <td colspan="6" class="text-center py-5 text-muted">
                    <i class="bi bi-inbox" style="font-size: 3rem"></i>
                    <div class="mt-2">
                      <strong>No subscriptions found</strong>
                      <div>
                        {{ searchText || statusFilter ? 'Try adjusting your
                        search or filter' : 'Add your first subscription above'
                        }}
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Monthly Cost Chart -->
      <div class="card custom-card">
        <div class="card-header bg-transparent">
          <h4 class="mb-0">
            <i class="bi bi-bar-chart me-2"></i>
            Monthly Cost Overview
          </h4>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="costChart" style="max-height: 400px"></canvas>
          </div>
          <div class="mt-3 text-center">
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              Shows total monthly costs for active subscriptions throughout 2025
            </small>
          </div>
        </div>
      </div>

      <!-- Loading Overlay -->
      <div
        ng-if="isLoading"
        class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
        style="background: rgba(0, 0, 0, 0.5); z-index: 9999"
      >
        <div class="text-center text-white">
          <div class="spinner-custom mb-3"></div>
          <div>Loading...</div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Logger -->
    <script src="/js/logger.js"></script>

    <!-- AngularJS Application -->
    <script>
      angular
        .module("subscriptionApp", [])
        .controller("SubscriptionController", [
          "$scope",
          "$http",
          "$window",
          "$timeout",
          "$location",
          "$anchorScroll",
          function (
            $scope,
            $http,
            $window,
            $timeout,
            $location,
            $anchorScroll
          ) {
            // Initialize scope variables
            $scope.subscriptions = [];
            $scope.newSubscription = {};
            $scope.searchText = "";
            $scope.statusFilter = "";
            $scope.smsData = {};
            $scope.smsMessage = "";
            $scope.smsError = "";
            $scope.subscriptionError = "";
            $scope.subscriptionSuccess = "";
            $scope.isLoading = false;
            $scope.isSubmitting = false;
            $scope.isSendingSMS = false;
            $scope.showDebug = localStorage.getItem("debugMode") === "true";

            let token = localStorage.getItem("token");
            let chart;

            // Log controller initialization
            logger.info("Subscription app controller initialized");
            logger.markStart("app-load");

            // Check authentication
            if (!token) {
              logger.error("No authentication token found");
              $window.location.href = "/";
              return;
            }

            // Get current user from token
            $scope.getCurrentUser = function () {
              try {
                const payload = JSON.parse(atob(token.split(".")[1]));
                return payload.user || "User";
              } catch (e) {
                return "User";
              }
            };

            // Load subscriptions on init
            $scope.loadSubscriptions = function () {
              logger.info("Loading subscriptions");
              $scope.isLoading = true;

              $http({
                method: "GET",
                url: "/api/subscriptions",
                headers: { Authorization: "Bearer " + token },
              }).then(
                function (response) {
                  $scope.subscriptions = response.data;
                  $scope.isLoading = false;
                  logger.info(`Loaded ${response.data.length} subscriptions`);
                  $timeout(() => $scope.updateChart(), 100);
                  logger.markEnd("app-load");
                },
                function (error) {
                  logger.error("Failed to load subscriptions", {
                    error: error.data,
                  });
                  $scope.isLoading = false;
                  if (error.status === 401) {
                    localStorage.removeItem("token");
                    $window.location.href = "/";
                  }
                }
              );
            };

            // Logout function
            $scope.logout = function () {
              logger.info("User logout initiated");
              localStorage.removeItem("token");
              $scope.subscriptions = [];
              $scope.newSubscription = {};
              $scope.searchText = "";
              $scope.statusFilter = "";
              $window.location.href = "/";
            };

            // Save subscription (Add or Update)
            $scope.saveSubscription = function () {
              logger.info("Saving subscription", {
                name: $scope.newSubscription.name,
                isUpdate: !!$scope.newSubscription._id,
              });

              $scope.isSubmitting = true;
              $scope.subscriptionError = "";
              $scope.subscriptionSuccess = "";

              // Validate required fields
              const requiredFields = [
                $scope.newSubscription.name,
                $scope.newSubscription.cost,
                $scope.newSubscription.renewalDate,
                $scope.newSubscription.provider,
                $scope.newSubscription.status,
              ];

              if (requiredFields.some((field) => !field)) {
                $scope.subscriptionError = "Please fill all required fields!";
                $scope.isSubmitting = false;
                logger.logFormValidation("subscription-form", false, [
                  "missing-required-fields",
                ]);
                return;
              }

              // Validate renewal year
              const renewalDate = new Date($scope.newSubscription.renewalDate);
              if (renewalDate.getFullYear() !== 2025) {
                $scope.subscriptionError = "Renewal year must be 2025!";
                $scope.isSubmitting = false;
                logger.logFormValidation("subscription-form", false, [
                  "invalid-year",
                ]);
                return;
              }

              logger.logFormValidation("subscription-form", true);

              const method = $scope.newSubscription._id ? "PUT" : "POST";
              const url = $scope.newSubscription._id
                ? "/api/subscriptions/" + $scope.newSubscription._id
                : "/api/subscriptions";

              const startTime = Date.now();
              $http({
                method: method,
                url: url,
                data: $scope.newSubscription,
                headers: { Authorization: "Bearer " + token },
              }).then(
                function (response) {
                  const duration = Date.now() - startTime;
                  const isUpdate = !!$scope.newSubscription._id;

                  logger.logRequest(method, url, 200, duration);
                  logger.info(
                    `Subscription ${
                      isUpdate ? "updated" : "added"
                    } successfully`
                  );

                  $scope.loadSubscriptions();
                  $scope.subscriptionSuccess = isUpdate
                    ? "Subscription updated successfully!"
                    : "Subscription added successfully!";

                  $scope.newSubscription = {};
                  $scope.isSubmitting = false;

                  // Clear success message after 3 seconds
                  $timeout(() => {
                    $scope.subscriptionSuccess = "";
                  }, 3000);
                },
                function (error) {
                  const duration = Date.now() - startTime;
                  logger.logRequest(method, url, error.status, duration);
                  logger.error("Failed to save subscription", {
                    error: error.data,
                  });

                  $scope.subscriptionError =
                    "Failed to " +
                    ($scope.newSubscription._id ? "update" : "add") +
                    " subscription!";
                  $scope.isSubmitting = false;
                }
              );
            };

            // Edit subscription
            $scope.editSubscription = function (subscription) {
              logger.logUserAction("edit-subscription", null, {
                subscriptionId: subscription._id,
              });
              $scope.newSubscription = angular.copy(subscription);

              // Format date for input
              if ($scope.newSubscription.renewalDate) {
                $scope.newSubscription.renewalDate = new Date(
                  $scope.newSubscription.renewalDate
                )
                  .toISOString()
                  .split("T")[0];
              }

              // Scroll to form
              $scope.scrollToElement("subName");
            };

            // Delete subscription
            $scope.deleteSubscription = function (id) {
              logger.logUserAction("delete-subscription", null, {
                subscriptionId: id,
              });

              const startTime = Date.now();
              $http({
                method: "DELETE",
                url: "/api/subscriptions/" + id,
                headers: { Authorization: "Bearer " + token },
              }).then(
                function () {
                  const duration = Date.now() - startTime;
                  logger.logRequest(
                    "DELETE",
                    `/api/subscriptions/${id}`,
                    200,
                    duration
                  );
                  logger.info("Subscription deleted successfully");
                  $scope.loadSubscriptions();
                },
                function (error) {
                  const duration = Date.now() - startTime;
                  logger.logRequest(
                    "DELETE",
                    `/api/subscriptions/${id}`,
                    error.status,
                    duration
                  );
                  logger.error("Failed to delete subscription", {
                    error: error.data,
                  });
                }
              );
            };

            // Clear or cancel form
            $scope.clearOrCancel = function () {
              logger.logUserAction("clear-or-cancel-form");
              $scope.newSubscription = {};
              $scope.subscriptionError = "";
              $scope.subscriptionSuccess = "";
            };

            // Clear SMS form
            $scope.clearSMS = function () {
              logger.logUserAction("clear-sms-form");
              $scope.smsData = {};
              $scope.smsError = "";
              $scope.smsMessage = "";
            };

            // Send SMS
            $scope.sendSMS = function () {
              logger.info("Sending SMS", { to: $scope.smsData.to });

              $scope.isSendingSMS = true;
              $scope.smsError = "";
              $scope.smsMessage = "";

              if (!$scope.smsData.to || !$scope.smsData.body) {
                $scope.smsError = "Please fill all SMS fields!";
                $scope.isSendingSMS = false;
                return;
              }

              const startTime = Date.now();
              $http({
                method: "POST",
                url: "/api/send-sms",
                data: $scope.smsData,
                headers: { Authorization: "Bearer " + token },
              }).then(
                function (response) {
                  const duration = Date.now() - startTime;
                  logger.logRequest("POST", "/api/send-sms", 200, duration);
                  logger.info("SMS sent successfully");

                  $scope.smsMessage = "SMS sent successfully";
                  $scope.smsData = {};
                  $scope.isSendingSMS = false;

                  $timeout(() => {
                    $scope.smsMessage = "";
                  }, 3000);
                },
                function (error) {
                  const duration = Date.now() - startTime;
                  logger.logRequest(
                    "POST",
                    "/api/send-sms",
                    error.status,
                    duration
                  );
                  logger.error("Failed to send SMS", { error: error.data });

                  $scope.smsError = error.data?.message || "Failed to send SMS";
                  $scope.isSendingSMS = false;
                }
              );
            };

            // Keyboard navigation
            $scope.moveToNextField = function (event, currentIndex, formType) {
              if (event.keyCode === 13) {
                event.preventDefault();

                let formFields;
                if (formType === "sms") {
                  formFields = ["smsPhone", "smsMessage"];
                } else {
                  formFields = [
                    "subName",
                    "subCost",
                    "subRenewal",
                    "subProvider",
                    "subStatus",
                    "subCancel",
                  ];
                }

                if (currentIndex < formFields.length - 1) {
                  document
                    .getElementById(formFields[currentIndex + 1])
                    ?.focus();
                } else {
                  if (formType === "sms") {
                    $scope.sendSMS();
                  } else {
                    $scope.saveSubscription();
                  }
                }
              }
            };

            // Utility functions
            $scope.getActiveSubscriptions = function () {
              return $scope.subscriptions.filter(
                (sub) => sub.status === "active"
              );
            };

            $scope.getCanceledSubscriptions = function () {
              return $scope.subscriptions.filter(
                (sub) => sub.status === "canceled"
              );
            };

            $scope.getUpcomingRenewals = function () {
              const today = new Date();
              const nextWeek = new Date();
              nextWeek.setDate(today.getDate() + 7);

              return $scope.subscriptions.filter((sub) => {
                const renewalDate = new Date(sub.renewalDate);
                return (
                  sub.status === "active" &&
                  renewalDate >= today &&
                  renewalDate <= nextWeek
                );
              });
            };

            $scope.getTotalMonthlyCost = function () {
              return $scope
                .getActiveSubscriptions()
                .reduce((total, sub) => total + (sub.cost || 0), 0);
            };

            $scope.getFilteredSubscriptions = function () {
              let filtered = $scope.subscriptions;

              if ($scope.searchText) {
                const search = $scope.searchText.toLowerCase();
                filtered = filtered.filter(
                  (sub) =>
                    sub.name.toLowerCase().includes(search) ||
                    sub.provider.toLowerCase().includes(search) ||
                    sub.status.toLowerCase().includes(search)
                );
              }

              if ($scope.statusFilter) {
                filtered = filtered.filter(
                  (sub) => sub.status === $scope.statusFilter
                );
              }

              return filtered;
            };

            $scope.getStatusClass = function (status) {
              switch (status) {
                case "active":
                  return "status-active";
                case "upcoming":
                  return "status-upcoming";
                case "canceled":
                  return "status-canceled";
                default:
                  return "";
              }
            };

            $scope.isRenewalSoon = function (subscription) {
              const today = new Date();
              const renewalDate = new Date(subscription.renewalDate);
              const daysDiff = Math.ceil(
                (renewalDate - today) / (1000 * 60 * 60 * 24)
              );
              return daysDiff <= 7 && daysDiff > 0;
            };

            $scope.isRenewalOverdue = function (subscription) {
              const today = new Date();
              const renewalDate = new Date(subscription.renewalDate);
              return renewalDate < today && subscription.status === "active";
            };

            $scope.getRenewalStatus = function (subscription) {
              const today = new Date();
              const renewalDate = new Date(subscription.renewalDate);
              const daysDiff = Math.ceil(
                (renewalDate - today) / (1000 * 60 * 60 * 24)
              );

              if (daysDiff < 0) return "Overdue";
              if (daysDiff === 0) return "Today";
              if (daysDiff === 1) return "Tomorrow";
              if (daysDiff <= 7) return `${daysDiff} days`;
              return `${Math.ceil(daysDiff / 7)} weeks`;
            };

            // Chart functions
            $scope.updateChart = function () {
              const monthlyCosts = new Array(12).fill(0);

              $scope.getActiveSubscriptions().forEach((sub) => {
                const month = new Date(sub.renewalDate).getMonth();
                monthlyCosts[month] += sub.cost || 0;
              });

              const ctx = document.getElementById("costChart").getContext("2d");
              if (chart) chart.destroy();

              chart = new Chart(ctx, {
                type: "bar",
                data: {
                  labels: [
                    "Jan",
                    "Feb",
                    "Mar",
                    "Apr",
                    "May",
                    "Jun",
                    "Jul",
                    "Aug",
                    "Sep",
                    "Oct",
                    "Nov",
                    "Dec",
                  ],
                  datasets: [
                    {
                      label: "Monthly Costs (₹)",
                      data: monthlyCosts,
                      backgroundColor: "rgba(102, 126, 234, 0.8)",
                      borderColor: "rgba(102, 126, 234, 1)",
                      borderWidth: 2,
                      borderRadius: 8,
                      borderSkipped: false,
                    },
                  ],
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      display: false,
                    },
                  },
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: {
                        callback: function (value) {
                          return "₹" + value.toLocaleString();
                        },
                      },
                    },
                  },
                },
              });
            };

            // Scroll to element
            $scope.scrollToElement = function (elementId) {
              $timeout(() => {
                const element = document.getElementById(elementId);
                if (element) {
                  element.scrollIntoView({
                    behavior: "smooth",
                    block: "start",
                  });
                  element.focus();
                }
              }, 100);
            };

            // Debug mode toggle
            document.addEventListener("keydown", function (event) {
              if (event.ctrlKey && event.shiftKey && event.key === "D") {
                event.preventDefault();
                $scope.$apply(function () {
                  $scope.showDebug = !$scope.showDebug;
                  localStorage.setItem(
                    "debugMode",
                    $scope.showDebug.toString()
                  );
                  logger.info("Debug mode toggled", {
                    enabled: $scope.showDebug,
                  });
                });
              }
            });

            // Initialize app
            $scope.loadSubscriptions();

            // Log when user leaves the page
            window.addEventListener("beforeunload", function () {
              logger.info("User leaving subscription manager app");
            });
          },
        ]);
    </script>
  </body>
</html>
